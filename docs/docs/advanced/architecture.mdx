# Architecture

this outlines the architecture to help contributors understand what components exist and what each does

## Spaces

there are three places where code can run

**userspace:** user-written code. in development it runs locally; when deployed, it runs inside an aws lambda

**client:** code packaged in the floww-sdk. itâ€™s responsible for invoking the userspace with the correct context

**server:** backend code that interacts with the database, deploys aws lambdas, and invokes them with the correct context

## Components

in addition to the spaces, several components coordinate everything

- **workos:** authentication provider across cli, admin page, dashboard, etc  
- **centrifugo:** manages websocket connections and broadcasting for live flow triggers  
- **cli:** part of the sdk that provides various commands  
- **sdk:** contains code for actions, plus typings for triggers and providers  
- **ecr:** aws registry storing docker runtimes used by lambdas  
- **ecr proxy:** provides fine-grained access control when pushing images to ecr  

## Flows

### (client) dev

:::note{title="1. prerequisites"}
<ol style={{marginBottom: '1rem', lineHeight: '1.4'}}>
  <li style={{marginBottom: '0.5rem'}}>check that the workflow exists</li>
</ol>
:::

:::note{title="2. execution"}
<ol style={{marginBottom: '1rem', lineHeight: '1.4'}}>
  <li style={{marginBottom: '0.5rem'}}>fetch available providers in the namespace</li>
  <li style={{marginBottom: '0.5rem'}}>initialize userspace with provider configs</li>
  <li style={{marginBottom: '0.5rem'}}>execute userspace (returns triggers and provider usage)</li>
  <li style={{marginBottom: '0.5rem'}}>
    verify all used providers are configured
    <ul style={{marginTop: '0.25rem', marginLeft: '1rem', lineHeight: '1.4'}}>
      <li>prompt user if any are missing</li>
    </ul>
  </li>
  <li style={{marginBottom: '0.5rem'}}>set up event routing to userspace (websocket + local events)</li>
</ol>
:::

:::info{title="reruns"}
<ul style={{lineHeight: '1.4'}}>
<li>code changes (reloads) re-run the flow from step 3</li>
<li>setting up a provider re-runs the flow from step 1</li>
</ul>
:::

### (client) deploy

:::note{title="1. prerequisites"}
<ol style={{marginBottom: '1rem', lineHeight: '1.4'}}>
  <li style={{marginBottom: '0.5rem'}}>
    check that the workflow exists
    <ul style={{marginTop: '0.25rem', marginLeft: '1rem', lineHeight: '1.4'}}>
      <li>if not, prompt the user to create one</li>
    </ul>
  </li>
</ol>
:::

:::note{title="2. checks"}
<ol style={{marginBottom: '1rem', lineHeight: '1.4'}}>
  <li style={{marginBottom: '0.5rem'}}>fetch available providers in the namespace</li>
  <li style={{marginBottom: '0.5rem'}}>execute userspace (returns triggers and provider usage)</li>
  <li style={{marginBottom: '0.5rem'}}>
    verify all used providers are configured
    <ul style={{marginTop: '0.25rem', marginLeft: '1rem', lineHeight: '1.4'}}>
      <li>prompt user if any are missing</li>
    </ul>
  </li>
</ol>
:::

:::note{title="3. deploy"}
<ol style={{marginBottom: '1rem', lineHeight: '1.4'}}>
  <li style={{marginBottom: '0.5rem'}}>build the runtime image</li>
  <li style={{marginBottom: '0.5rem'}}>upload runtime image (if missing)</li>
  <li style={{marginBottom: '0.5rem'}}>create runtime (if missing)</li>
  <li style={{marginBottom: '0.5rem'}}>create deployment</li>
</ol>
:::

:::info{title="reruns"}
<ul style={{lineHeight: '1.4'}}>
<li>setting up a provider re-runs the checks flow from step 2</li>
</ul>
:::

### (server) incoming webhook

:::note{title=""}
<ul style={{lineHeight: '1.4'}}>
<li>setting up a provider re-runs the checks flow from step 2</li>
</ul>
:::
